<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager - Sticky Notes</title>
    <link rel="stylesheet" href="static/style.css">
</head>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
var socket = io(); // Connect to Flask-SocketIO Server

document.addEventListener('DOMContentLoaded', () => {

    // SEND TO BACKEND
    const text = document.querySelector('#text')
    document.querySelector('#save').addEventListener('click', () => {
        if (text.value.trim() !== "") {
            // Send text to backend
                fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        type: "text",
                        text: text.value
                    })
                });
                text.value = "" // Clear the form
        }
        else {
            alert("Text required");
    }})

    // SHOW FROM EMIT
    socket.on("task", (data) => {
        const taskContainer = document.querySelector('.task-container');
        const formContainer = document.querySelector('.form-container');

        const task = data;  // Grab the task from the emit

        const note = document.createElement('div'); // Create a note element
        note.classList.add('sticky-note'); // add CSS class 'sticky-note' to it

        note.dataset.id = task.id; // Store the task ID in a data attribute

        const p = document.createElement('p'); // Create a <p> element to hold the text
        p.textContent = task.description || "No description provided."; // Fill th text
        note.appendChild(p); // Nest p inside of the note div

        const b = document.createElement('button') // Create a <button> element for deleting
        b.classList.add('delete-btn'); // add the delete class
        b.textContent = "Delete"; // Fill th text
        note.appendChild(b); // Nest b inside of the note div

        // Event listener for dynamically created buttons
        b.addEventListener('click', () => {
            const taskId = note.dataset.id; // Get the id from the created task
            //console.log("deleting task with id:", taskId)
            const currentTask = document.querySelector(`.sticky-note[data-id="${taskId}"]`) // get the task based on current ID\
            if (currentTask) currentTask.remove() // remove the task from js if it exists

            // Send id to backend to be deleted
            fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        type: "delete",
                        id: taskId
                    })
                });

        })

        taskContainer.insertBefore(note, formContainer);  // Insert the new task before the formContainer
    });

    // DELETE BUTTON FOR STATIC
    const deleteButton = document.querySelectorAll('.delete-btn');
    deleteButton.forEach(button => {
        button.addEventListener('click', () => { 
            const taskId = button.dataset.id; // Get the id from the button
            //console.log("deleting task with id:", taskId)
            const currentTask = document.querySelector(`.sticky-note[data-id="${taskId}"]`) // get the task based on current ID\
            if (currentTask) currentTask.remove() // remove the task from js if it exists

            // Send id to backend to be deleted
            fetch("/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        type: "delete",
                        id: taskId
                    })
                });

        })

    })

});

</script>

<body>

    <!-- Task Manager Title -->
    <h1>Task Manager</h1>

    <!-- Dynamically Generated Sticky Notes (Tasks) -->
    <div class="task-container">

         {% for task in tasks %}
         <div class="sticky-note" data-id="{{ task[0]}}">
            <p>{{ task[1] or 'No description provided.' }}</p>
            <button type="button" class="delete-btn" data-id="{{ task[0]}}">Delete</button>
        </div>
        {% endfor %}
         
        <!-- Main container with form and tasks side by side -->

        <div class="form-container sticky-note">
            <form>
                <textarea id="text" name="text" placeholder="Type to add a note..." required></textarea>
            
                <button type="button" id="save">Save</button>
            </form>
        </div>

    </div>



</body>
</html>